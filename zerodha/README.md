# Zerodha Data Fetcher

This system connects to the Zerodha API, fetches real-time market data, and stores it in QuestDB.

## Recent Improvements

### Queue Handling

The system was experiencing issues with the queue becoming full, resulting in "Timeout waiting for queue.put() to complete" warnings. We made the following improvements:

1. **Bounded Queue**: Added a maximum size limit (10,000 items) to the queue to prevent unbounded memory growth
2. **Smart Queue Management**: Implemented non-blocking queue operations with timeouts to avoid blocking the WebSocket thread
3. **Graceful Dropping**: Added logic to smartly drop ticks when the queue is full instead of blocking
4. **Batch Size Optimization**: Increased batch sizes for more efficient database writes

### Performance Improvements

1. **Filtered Instruments**: Reduced the number of instruments being tracked from 250+ to ~100 high-priority instruments
2. **Reduced Connectors**: Limited to 1 connector to manage data flow more efficiently
3. **Dynamic Batch Timeouts**: Adjusted batch processing timeouts based on queue pressure
4. **Exponential Backoff**: Added exponential backoff for database errors to avoid hammering the database

### Monitoring & Metrics

1. **Enhanced Metrics**: Improved the metrics.json file with more detailed statistics
2. **Status Checking**: Created tools to check system health:
   - `check_metrics.py` - Shows current system metrics
   - `check_system.py` - Runs comprehensive checks on connections and metrics
   - `queue_pressure_test.py` - Tests queue handling under load

## Usage

### Starting the System

```bash
python zerodha_run_connector.py
```

### Check System Status 

```bash
python check_metrics.py
```

### Run Connection Test

```bash
python ticker_test.py
```

### Full System Check

```bash
python check_system.py
```

## Configuration

The system uses a `.env` file for configuration with the following parameters:

- `ZERODHA_API_KEY` - Your Zerodha API key
- `ZERODHA_API_SECRET` - Your Zerodha API secret 
- `ZERODHA_ACCESS_TOKEN` - Access token (generated by authentication process)
- `QUESTDB_HOST` - QuestDB server hostname
- `QUESTDB_PORT` - QuestDB server port (typically 443 for HTTPS)
- `QUESTDB_USER` - QuestDB username
- `QUESTDB_PASSWORD` - QuestDB password

## Authentication

Authentication is a two-step process:

1. Run `python listener.py` to start the local HTTP server
2. Run `python zerodha_token_automation.py` to open browser and authenticate

## Troubleshooting

- If you see "queue full" warnings, consider reducing the number of instruments or increasing batch size
- If metrics.json is not being updated, check file permissions
- If QuestDB connection is failing, verify credentials and network connectivity
- Run `check_system.py` for a full diagnostic report

## System Architecture

The system has the following components:

1. **Zerodha Connector** - Connects to Zerodha WebSocket and receives market data
2. **Queue System** - Buffers data between connector and database writer
3. **DB Writer** - Processes queued data in batches and writes to QuestDB  
4. **Metrics Tracker** - Monitors system performance and writes to metrics.json

Data flows: Zerodha API → WebSocket → Queue → Batch Processing → QuestDB 